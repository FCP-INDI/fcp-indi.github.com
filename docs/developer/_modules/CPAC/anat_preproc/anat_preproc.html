<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>CPAC.anat_preproc.anat_preproc &mdash; C-PAC 0.3.9 Alpha documentation</title>
    
    <link rel="stylesheet" href="../../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.3.9 Alpha',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="C-PAC 0.3.9 Alpha documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">C-PAC 0.3.9 Alpha documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for CPAC.anat_preproc.anat_preproc</h1><div class="highlight"><pre>
<span class="kn">from</span> <span class="nn">nipype.interfaces.afni</span> <span class="kn">import</span> <span class="n">preprocess</span>
<span class="kn">import</span> <span class="nn">nipype.pipeline.engine</span> <span class="kn">as</span> <span class="nn">pe</span>
<span class="c">#import nipype.interfaces.afni as afni</span>
<span class="kn">import</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">as</span> <span class="nn">util</span>


<div class="viewcode-block" id="create_anat_preproc"><a class="viewcode-back" href="../../../workflows/anat_preproc.html#CPAC.anat_preproc.create_anat_preproc">[docs]</a><span class="k">def</span> <span class="nf">create_anat_preproc</span><span class="p">(</span><span class="n">already_skullstripped</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    </span>
<span class="sd">    The main purpose of this workflow is to process T1 scans. Raw mprage file is deobliqued, reoriented </span>
<span class="sd">    into RPI and skullstripped. Also, a whole brain only mask is generated from the skull stripped image </span>
<span class="sd">    for later use in registration.</span>
<span class="sd">    </span>
<span class="sd">    Returns </span>
<span class="sd">    -------</span>
<span class="sd">    anat_preproc : workflow</span>
<span class="sd">        Anatomical Preprocessing Workflow</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    </span>
<span class="sd">    `Source &lt;https://github.com/FCP-INDI/C-PAC/blob/master/CPAC/anat_preproc/anat_preproc.py&gt;`_</span>
<span class="sd">    </span>
<span class="sd">    Workflow Inputs::</span>
<span class="sd">    </span>
<span class="sd">        inputspec.anat : mprage file or a list of mprage nifti file </span>
<span class="sd">            User input anatomical(T1) Image, in any of the 8 orientations</span>
<span class="sd">    </span>
<span class="sd">    Workflow Outputs::</span>
<span class="sd">    </span>
<span class="sd">        outputspec.refit : nifti file</span>
<span class="sd">            Deobliqued anatomical data </span>
<span class="sd">        outputspec.reorient : nifti file</span>
<span class="sd">            RPI oriented anatomical data </span>
<span class="sd">        outputspec.skullstrip : nifti file</span>
<span class="sd">            Skull Stripped RPI oriented mprage file with normalized intensities.</span>
<span class="sd">        outputspec.brain : nifti file</span>
<span class="sd">            Skull Stripped RPI Brain Image with original intensity values and not normalized or scaled.</span>
<span class="sd">    </span>
<span class="sd">    Order of commands:</span>

<span class="sd">    - Deobliqing the scans.  For details see `3drefit &lt;http://afni.nimh.nih.gov/pub/dist/doc/program_help/3drefit.html&gt;`_::</span>
<span class="sd">    </span>
<span class="sd">        3drefit -deoblique mprage.nii.gz</span>
<span class="sd">        </span>
<span class="sd">    - Re-orienting the Image into Right-to-Left Posterior-to-Anterior Inferior-to-Superior  (RPI) orientation.  For details see `3dresample &lt;http://afni.nimh.nih.gov/pub/dist/doc/program_help/3dresample.html&gt;`_::</span>
<span class="sd">    </span>
<span class="sd">        3dresample -orient RPI -prefix mprage_RPI.nii.gz -inset mprage.nii.gz </span>
<span class="sd">    </span>
<span class="sd">    - SkullStripping the image.  For details see `3dSkullStrip &lt;http://afni.nimh.nih.gov/pub/dist/doc/program_help/3dSkullStrip.html&gt;`_::</span>
<span class="sd">    </span>
<span class="sd">        3dSkullStrip -input mprage_RPI.nii.gz -o_ply mprage_RPI_3dT.nii.gz</span>
<span class="sd">    </span>
<span class="sd">    - The skull stripping step modifies the intensity values. To get back the original intensity values, we do an element wise product of RPI data with step function of skull Stripped data.  For details see `3dcalc &lt;http://afni.nimh.nih.gov/pub/dist/doc/program_help/3dcalc.html&gt;`_::</span>
<span class="sd">    </span>
<span class="sd">        3dcalc -a mprage_RPI.nii.gz -b mprage_RPI_3dT.nii.gz -expr &#39;a*step(b)&#39; -prefix mprage_RPI_3dc.nii.gz</span>
<span class="sd">    </span>
<span class="sd">    High Level Workflow Graph:</span>
<span class="sd">    </span>
<span class="sd">    .. image:: ../images/anatpreproc_graph.dot.png</span>
<span class="sd">       :width: 500</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Detailed Workflow Graph:</span>
<span class="sd">    </span>
<span class="sd">    .. image:: ../images/anatpreproc_graph_detailed.dot.png</span>
<span class="sd">       :width: 500</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    </span>
<span class="sd">    &gt;&gt;&gt; import anat</span>
<span class="sd">    &gt;&gt;&gt; preproc = create_anat_preproc()</span>
<span class="sd">    &gt;&gt;&gt; preproc.inputs.inputspec.anat=&#39;sub1/anat/mprage.nii.gz&#39;</span>
<span class="sd">    &gt;&gt;&gt; preproc.run() #doctest: +SKIP</span>
<span class="sd">            </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">preproc</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;anat_preproc&#39;</span><span class="p">)</span>
    <span class="n">inputNode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;anat&#39;</span><span class="p">]),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s">&#39;inputspec&#39;</span><span class="p">)</span>
    <span class="n">outputNode</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">util</span><span class="o">.</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;refit&#39;</span><span class="p">,</span>
                                                    <span class="s">&#39;reorient&#39;</span><span class="p">,</span>
                                                    <span class="s">&#39;skullstrip&#39;</span><span class="p">,</span>
                                                    <span class="s">&#39;brain&#39;</span><span class="p">]),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s">&#39;outputspec&#39;</span><span class="p">)</span>
    <span class="n">anat_deoblique</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">preprocess</span><span class="o">.</span><span class="n">Refit</span><span class="p">(),</span>
                         <span class="n">name</span><span class="o">=</span><span class="s">&#39;anat_deoblique&#39;</span><span class="p">)</span>
    <span class="n">anat_deoblique</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">deoblique</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">anat_reorient</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">preprocess</span><span class="o">.</span><span class="n">Resample</span><span class="p">(),</span>
                            <span class="n">name</span><span class="o">=</span><span class="s">&#39;anat_reorient&#39;</span><span class="p">)</span>
    <span class="n">anat_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">orientation</span> <span class="o">=</span> <span class="s">&#39;RPI&#39;</span>
    <span class="n">anat_reorient</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s">&#39;NIFTI_GZ&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">already_skullstripped</span><span class="p">:</span>
        <span class="n">anat_skullstrip</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">preprocess</span><span class="o">.</span><span class="n">SkullStrip</span><span class="p">(),</span>
                                  <span class="n">name</span><span class="o">=</span><span class="s">&#39;anat_skullstrip&#39;</span><span class="p">)</span>
        <span class="c">#anat_skullstrip.inputs.options = &#39;-o_ply&#39;</span>
        <span class="n">anat_skullstrip</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s">&#39;NIFTI_GZ&#39;</span>
    <span class="n">anat_skullstrip_orig_vol</span> <span class="o">=</span> <span class="n">pe</span><span class="o">.</span><span class="n">Node</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">preprocess</span><span class="o">.</span><span class="n">Calc</span><span class="p">(),</span>
                        <span class="n">name</span><span class="o">=</span><span class="s">&#39;anat_skullstrip_orig_vol&#39;</span><span class="p">)</span>
    <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">expr</span> <span class="o">=</span> <span class="s">&#39;a*step(b)&#39;</span>
    <span class="n">anat_skullstrip_orig_vol</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">outputtype</span> <span class="o">=</span> <span class="s">&#39;NIFTI_GZ&#39;</span>
     
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">inputNode</span><span class="p">,</span> <span class="s">&#39;anat&#39;</span><span class="p">,</span>
                    <span class="n">anat_deoblique</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">anat_reorient</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">already_skullstripped</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s">&#39;in_file&#39;</span><span class="p">)</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s">&#39;in_file_b&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s">&#39;in_file_b&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s">&#39;in_file_a&#39;</span><span class="p">)</span>
   
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_deoblique</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">outputNode</span><span class="p">,</span> <span class="s">&#39;refit&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_reorient</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                    <span class="n">outputNode</span><span class="p">,</span> <span class="s">&#39;reorient&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">already_skullstripped</span><span class="p">:</span>
        <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputNode</span><span class="p">,</span> <span class="s">&#39;skullstrip&#39;</span><span class="p">)</span>
    <span class="n">preproc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">anat_skullstrip_orig_vol</span><span class="p">,</span> <span class="s">&#39;out_file&#39;</span><span class="p">,</span>
                        <span class="n">outputNode</span><span class="p">,</span> <span class="s">&#39;brain&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">preproc</span>
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">C-PAC 0.3.9 Alpha documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015, C-PAC Team.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.3.1.
    </div>
  </body>
</html>