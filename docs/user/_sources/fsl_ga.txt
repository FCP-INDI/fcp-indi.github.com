Group-Level Statistics
----------------------
C-PAC uses `FSL/FEAT <http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FEAT/UserGuide>`_ to compare findings across groups and run statistical analysis. Users create a model file that includes group, phenotypic, and nuisance regressors for each subject, and the data is `run through a GLM <http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FEAT/UserGuide#Appendix_A:_Brief_Overview_of_GLM_Analysis>`_.

Model files can be `created manually through FSL <http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FEAT/UserGuide#FEAT_in_Detail>`_, or by using the C-PAC FSL Model Script and instructions below.



When you have created the necessary model files, please refer to the Configuring C-PAC section below.

Prepare Phenotypic Information and Other Regressors
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Phenotypic information and nuisance regressors are specified in a :file:`.csv` file, with subjects as rows and regressors as columns. A :file:`template_phenotypic.csv` is generated when you :doc:`prepare your data </use>`, and includes rows for all subjects to be included in group satistics. Open this file, create a column for each phenotypic variable or regressor you would like included in your model, and enter the appropriate value for each subject.

If you would like to include motion parameters calcualted by C-PAC, download the :file:`extract_parameters.py` script. Navigate to your main C-PAC output directory and run it by typing::

    python extract_parameters.py /path/to/output/directory

Where :file:`/path/to/output/directory` is the path to :file:`sinkDir` as specified in :file:`config.py`. This will output a motion parameters :file:`.csv` file in the top level of each pipeline directory.

When you are finished, save your changes. Future versions of C-PAC will automate this process.

Configure FSL Model Script
^^^^^^^^^^^^^^^^^^^^^^^^^^
Open :file:`config_fsl.py`, which can be `downloaded here <https://raw.github.com/FCP-INDI/C-PAC/master/configs/config_fsl.py>`_. Enter the regressors you would like to include, the path to :file:`template_phenotypic.csv`, and a name for the .csv model file to be output. Save your changes.

Run FSL Model Script
^^^^^^^^^^^^^^^^^^^^
Open iPython and type::

    import CPAC
    CPAC.utils.create_fsl_model.run ('/path/to/config_fsl_py', 'generate_model_csv')

This will output a .csv model file with the name you specified.

Reconfigure FSL Script
^^^^^^^^^^^^^^^^^^^^^^
Based on the columns you have included in your model, create a contrast file using FSL. Specify the location of this file in :file:`config_fsl.py`, as well as a name for the model.

Run FSL Script Again
^^^^^^^^^^^^^^^^^^^^
Open iPython and type::

    import CPAC
    create_fsl_model.run ('/path/to/config_fsl_py', 'generate_model_fsl_files')

This will output the standard FSL model files in the directory from which the script is run. You may then specify the location of these files in :file:`config.py`, and :doc:`run the C-PAC group pipeline </use>`.

Configuring C-PAC
^^^^^^^^^^^^^^^^^
The following settings in :file:`config.py` are used to configure Group Statistics.

groupAnalysisSubjectList
""""""""""""""""""""""""
Specify the full path to a list of subjects on which to run group statistics::

    # This file should be created automatically when you run extract_data.py
    # The order of subjects in this list must match the order in your model
    groupAnalysisSubjectList = '/path/to/subject_list_group_analysis.txt'

derivativeList
""""""""""""""
Select which measures should be included in group analysis:

* sca_seed_Z_to_standard_smooth = voxel-based SCA
* sca_roi_Z_to_standard_smooth = ROI based SCA
* alff_Z_to_standard_smooth = ALFF
* falff_Z_to_standard_smooth  = fALFF
* vmhc_z_score_stat_map = VMHC
* reho_Z_to_standard_smooth = ReHo

::

    derivativeList = ['sca_seed_Z_to_standard_smooth', \
                      'sca_roi_Z_to_standard_smooth', \
                      'alff_Z_to_standard_smooth', \
                      'falff_Z_to_standard_smooth', \
                      'vmhc_z_score_stat_map', \
                      'reho_Z_to_standard_smooth']

modelFile
"""""""""
Specify the full path to a text file contaning a list of FSL models::

    # Each line in this file should be the path to a model directory
    # Each model directory should contain a .mat, .con, and .grp file
    # If fTest = True (see below), model directories must also contain a .fts file
    # These models can be generated through FSL, or using create_fsl_model.py
    modelFile = '/path/to/subject_list_model_list.txt'

For instructions on building FSL model files using the C-PAC scripts, :doc:`click here </fsl_ga.rst>`

mixedScanAnalysis
"""""""""""""""""
Specify whether to include all scans from a subject or only a single session::

    # If a subjecs has multiple scans:
    # False = Consdier only the first scan session during group analysis
    # True = Consider all scan sessions
    mixedScanAnalysis = False

Thresholds
""""""""""
Specify statistical thresholds::

    zThreshold = 2.3

    pThreshold = 0.05

fTest
"""""
Specify whether to run an F-test::

    # Options are True/False
    fTest = True


