Group-Level Statistics
======================
Overview
^^^^^^^^
C-PAC uses `FSL/FEAT <http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FEAT/UserGuide>`_ to compare findings across groups.

Users create a model file that includes group, phenotypic, and nuisance regressors for each subject, and the data is `run through a General Linear Model (GLM) based on pre-defined comparisons (contrasts) <http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FEAT/UserGuide#Appendix_A:_Brief_Overview_of_GLM_Analysis>`_.

The following links provide a good introduction to how groups are compared using FSL, as well as how to define contrasts.

* http://ccn.ucla.edu/wiki/images/c/c7/FSL_workshop_FEAT_2.pdf

* http://www.fmrib.ox.ac.uk/fslcourse/lectures/feat1_part2.pdf

* http://www.cubric.cf.ac.uk/neuroimaging-training/session5_group.pdf

This page will walk you through the following steps necessary to run group statistics:

* Gather phenotypic information and other regressors.
* Set up contrasts.
* Create a model (either through FSL or using the C-PAC FSL Model Script)

.. figure:: /images/run_workflow.png

Model files can be `created manually through FSL <http://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FEAT/UserGuide#FEAT_in_Detail>`_, or by using the C-PAC FSL Model Script and instructions below. If you choose to create your model files using FSL, please skip to the Configuring C-PAC section.

Prepare Phenotypic Information and Other Regressors
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
Explanatory variables (EVs) such as phenotypic characteristics and group membership, as well as nuisance regressors, are specified in a :file:`.csv` file, with subjects as rows and regressors as columns. A :file:`template_phenotypic.csv` is generated when you :doc:`prepare your data </use>`, and includes rows for all subjects to be included in group satistics. Open this file, create a column for each phenotypic or nuisance regressor you would like included in your model, and enter the appropriate value for each subject.

.. figure:: /images/phenotypic_csv.png

If you would like to include motion parameters calcualted by C-PAC as nuisance regressors, `download <https://raw.github.com/FCP-INDI/C-PAC/master/tools/extract_parameters.py>`_ the :file:`extract_parameters.py` script. Navigate to your main C-PAC output directory and run it by typing::

    python extract_parameters.py /path/to/output/directory

Where :file:`/path/to/output/directory` is the path to your output directory (:file:`sinkDir` as specified in :file:`config.yml`). This will output a :file:`...all_params.csv` file in the top level of each pipeline directory which contains all motion parameters calculated by C-PAC. You can then copy the columns from this file into your :file:`template_phenotypic.csv` file. When you are finished, save your changes. Future versions of C-PAC will automate this process.



Configure FSL Model Script
^^^^^^^^^^^^^^^^^^^^^^^^^^
Open :file:`config_fsl.yml`, which can be `downloaded here <https://raw.github.com/FCP-INDI/C-PAC/master/configs/config_fsl.yml>`_. 

Specify which regressors you would like included in your model by listing names of columns in your :file:`template_phenotypic.csv`::

    # Specify which phenotypic variables and regressors to include in model
    # These names should match column names in template_phenotypic.csv
    columnsInModel = ['AgeAtScan', 'MeanFD', 'site', 'DxGroup']

Define whether each regressor is categorical (such as age or diagnosis) or directional (such as age or a test score)::

    # Set a type for each of the variables/regressors entered above.
    # 1 = categorical, 0 = directional
    categoricalVsDirectional = [0, 0, 1, 1]

Specify which regressors should be de-meaned::

    # Specify whether to de-mean each column.
    deMean = [1, 1, 0, 0]

Set the location of your modified :file:`template_phenotypic.csv` file::

    # Specify the full path to template_phenotypic.csv
    phenotypicFile = '/path/to/template_phenotypic.csv'

Set the location of the :file:`subject_list_group_analysis.txt` file generated when you ran :file:`extract_data.py`::

    # Specify the full path to subject_list_group_analysis.txt
    subjectListFile = '/path/to/subject_list_group_analysis.txt'

Specify a name for a model file :file:`.csv` to be output::

    outputModelFile = '/home/ssikka/nki_nyu_pipeline/model_fsl.csv'

Define Contrasts
^^^^^^^^^^^^^^^^
Based on the columns present in the model :file:`.csv` you just generated, create a new spreadsheet specifying your desired contrasts. 

.. figure:: /images/contrasts_csv.png

Save this file, and set the path to it in :file:`fsl_config.py`::

    # Full path to a contrast file based on the columns listed above.
    contrastFile = '/home/ssikka/nki_nyu_pipeline/contrasts.csv'

Finally, define what you would like to name your model::

    # Specify a name for the model.
    modelName = 'my_model'

Run FSL Script
^^^^^^^^^^^^^^
Open iPython and type::

    import CPAC
    create_fsl_model.run ('/path/to/config_fsl_py')

This will output the standard FSL model files in the directory from which the script is run. You may then specify the location of these files in :file:`config.yml`, and :doc:`run the C-PAC group pipeline </use>`.

.. figure:: /images/model.png

Configuring C-PAC
^^^^^^^^^^^^^^^^^
The following settings in :file:`config.yml` are used to configure Group Statistics.

groupAnalysisSubjectList
""""""""""""""""""""""""
Specify the full path to a list of subjects on which to run group statistics::

    # This file should be created automatically when you run extract_data.py
    # The order of subjects in this list must match the order in your model
    groupAnalysisSubjectList = '/path/to/subject_list_group_analysis.txt'

derivativeList
""""""""""""""
Select which measures should be included in group analysis:

* sca_seed_Z_to_standard_smooth = voxel-based SCA
* sca_roi_Z_to_standard_smooth = ROI based SCA
* alff_Z_to_standard_smooth = ALFF
* falff_Z_to_standard_smooth  = fALFF
* vmhc_z_score_stat_map = VMHC
* reho_Z_to_standard_smooth = ReHo

::

    derivativeList = ['sca_seed_Z_to_standard_smooth', \
                      'sca_roi_Z_to_standard_smooth', \
                      'alff_Z_to_standard_smooth', \
                      'falff_Z_to_standard_smooth', \
                      'vmhc_z_score_stat_map', \
                      'reho_Z_to_standard_smooth']

modelFile
"""""""""
Specify the full path to a text file contaning a list of FSL models::

    # Each line in this file should be the path to a model directory
    # Each model directory should contain a .mat, .con, and .grp file
    # If fTest = True (see below), model directories must also contain a .fts file
    # These models can be generated through FSL, or using create_fsl_model.py
    modelFile = '/path/to/subject_list_model_list.txt'

For instructions on building FSL model files using the C-PAC scripts, :doc:`click here </fsl_ga.rst>`

mixedScanAnalysis
"""""""""""""""""
Specify whether to include all scans from a subject or only a single session::

    # If a subjecs has multiple scans:
    # False = Consdier only the first scan session during group analysis
    # True = Consider all scan sessions
    mixedScanAnalysis = False

Thresholds
""""""""""
Specify statistical thresholds::

    zThreshold = 2.3

    pThreshold = 0.05

fTest
"""""
Specify whether to run an F-test::

    # Options are True/False
    fTest = True


