fMRIPrep XCP Benchmark 
------------------------

fMRIPrep 
^^^^^^^^^^^^^^^^^^^^^
`fMRIPrep <https://fmriprep.readthedocs.io/en/stable/>`_ is a functional magnetic resonance imaging (fMRI) data preprocessing pipeline that provides an easily accessible interface and that requires minimal user input. It performs basic processing steps (coregistration, normalization, unwarping, noise component extraction, segmentation, skullstripping etc.) providing outputs that can be submitted to group level analyses. 

To improve reproducibility, methods of key steps in fMRIPrep and C-PAC are surveyed and additional configuration options are implemented in C-PAC to enable the generation of a C-PAC pipeline configuration file that closely matches fMRIPrep (`fMRIPrep config <https://github.com/FCP-INDI/C-PAC/blob/develop/CPAC/resources/configs/pipeline_config_fmriprep-options.yml>`_). 


Run C-PAC with fMRIPrep-Options Configuration  
""""""""""""""""""""""""""""""""""""""

Users can run fMRIPrep-options configuration with --preconfig fmriprep-options since C-PAC 1.6.1.

.. code-block:: console

    docker run -i --rm \
            -v /Users/You/local_bids_data:/bids_dataset \
            -v /Users/You/template_folder:/templates \
            -v /Users/You/some_folder:/outputs \
            -v /tmp:/scratch \
            fcpindi/c-pac:latest /bids_dataset /outputs participant --preconfig fmriprep-options


fMRIPrep-Options Configuration Details 
"""""""""""""""""""""""""""""""

Details in fMRIPrep-options configuration which are different from C-PAC default configuration are shown below.

.. code-block:: console

    # Resolution
    resolution_for_anat: 1mm
    resolution_for_func: 3.438mmx3.438mmx3.4mm # functional resolution in native space 

    # Templates
    template_brain_only_for_anat: /templates/tpl-MNI152NLin2009cAsym_res-01_desc-brain_T1w.nii.gz
    template_skull_for_anat: /templates/skull_mni_icbm152_t1_tal_nlin_asym_09c.nii.gz
    template_for_resample: /templates/tpl-MNI152NLin2009cAsym_res-01_desc-brain_T1w.nii.gz
    template_brain_only_for_func: /templates/tpl-MNI152NLin2009cAsym_res-02_T1w_reference.nii.gz
    template_skull_for_func: /templates/tpl-MNI152NLin2009cAsym_res-02_T1w_reference.nii.gz

    # Motion Estimation
    runMotionStatisticsFirst: [1]

    # Brain Extraction
    skullstrip_option: [niworkflows-ants]

    # Tissue Segmentation
    seg_use_threshold: [Customized Thresholding]

    seg_CSF_threshold_value: 0.95
    seg_WM_threshold_value: 0.95
    seg_GM_threshold_value: 0.95

    brain_use_erosion: true
    brain_mask_erosion_prop : 0
    brain_mask_erosion_mm : 30
    brain_erosion_mm: 0

    seg_csf_use_erosion: true
    csf_erosion_prop: 0
    csf_mask_erosion_mm: 30
    csf_erosion_mm: 0

    seg_wm_use_erosion: true
    wm_erosion_prop: 0.6
    wm_mask_erosion_mm: 0
    wm_erosion_mm: 0

    seg_gm_use_erosion: false
    gm_erosion_prop: 0.6
    gm_mask_erosion_mm: 30
    gm_erosion_mm: 0

    # BOLD Mask Generation
    functionalMasking: [FSL_AFNI]

    # Spatial Normalization 
    non_local_means_filtering: false
    n4_bias_field_correction: true

    # Co-registration 
    n4_correct_mean_EPI: true

    # Nuisance Signal Generation
    lateral_ventricles_mask: None

    Regressors:
    - Bandpass:
        bottom_frequency: 0.01
        top_frequency: 0.1
      CerebrospinalFluid:
        erode_mask: false
        summary: Mean
        extraction_resolution: 2
      Motion:
        include_delayed: true
        include_delayed_squared: true
        include_squared: true
      PolyOrt:
        degree: 2
      GlobalSignal:
        summary: Mean
      WhiteMatter:
        erode_mask: false
        summary: Mean
        extraction_resolution: 2
      aCompCor:
        summary:
          components: 5
          filter: cosine
          method: PC
        tissues:
          - WhiteMatter
          - CerebrospinalFluid
        extraction_resolution: 2
      tCompCor:
        summary:
          components: 5
          filter: cosine
          method: PC
        threshold: 5PCT
        erode_mask_mm: True
        degree: 2

References
^^^^^^^^^^^^^^^^^^^^^
Esteban, O. et al. (2019). fMRIPrep: a robust preprocessing pipeline for functional MRI. Nat. Methods 16, 111â€“116
